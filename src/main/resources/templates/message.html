<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Messaging</title>
  <style>
    /* Floating Chat Button */
    .chat-button {
    position: fixed;
    top: 20px;
    left: 20px;
    background-color: #0073b1;
    color: white;
    padding: 10px 15px;
    border-radius: 15px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
    z-index: 1001;
}


    /* Chat Popup */
    .chat-popup {
    position: fixed;
    top: 60px;
    left: 20px;
    width: 300px;
    background-color: white;
    border-radius: 10px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
    display: none;
    flex-direction: column;
    z-index: 1000;
}

    /* Chat Window */
    .chat-window {
    position: fixed;
    top: 60px;
    left: 330px; /* Appears next to chat popup */
    width: 500px;
    background-color: white;
    border-radius: 10px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
    display: none;
    flex-direction: column;
    z-index: 1000;
}

    /* Chat Header */
    .chat-header {
        background-color: #0073b1;
        color: white;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }

    /* Chat Body */
    .chat-body {
        padding: 15px;
        height: 250px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .message {
        display: flex;
        max-width: 60%;
        margin: 5px;
        padding: 10px;
        border-radius: 10px;
        font-size: 14px;
        word-wrap: break-word;
    }

    /* Messages sent by the user (aligned right) */
    .sent {
        align-self: flex-end;
        background-color: #007bff;
        color: white;
        text-align: right;
        margin-left: auto;
    }

    /* Messages received from other users (aligned left) */
    .received {
        align-self: flex-start;
        background-color: #e5e5ea;
        color: black;
        text-align: left;
        margin-right: auto;
    }

    /* Style for message text */
    .message-text {
        display: block;
        padding: 5px 10px;
    }

    /* Style for timestamp */
    .message-time {
        display: block;
        font-size: 12px;
        opacity: 0.7;
        margin-top: 5px;
    }


    /* Chat Footer */
    .chat-footer {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ccc;
    }

    .chat-footer input {
        flex: 1;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .chat-footer button {
        background-color: #0073b1;
        color: white;
        padding: 5px 10px;
        border: none;
        cursor: pointer;
    }

    /* User List */
    .user-list {
        margin: 10px 0;
        padding: 0;
        list-style: none;
    }

    .user-list li {
        padding: 8px;
        cursor: pointer;
        border-bottom: 1px solid #ccc;
    }

    .user-list li:hover {
        background-color: #f1f1f1;
    }
  </style>

  <!-- Include SockJS and STOMP libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>

<!-- Floating Chat Button -->
<div id="chat-button" class="chat-button">
  Messaging
</div>

<!-- Chat Popup -->
<div id="chat-popup" class="chat-popup">
  <div class="chat-header">
    <span>Messages</span>
    <button id="close-chat">✕</button>
  </div>

  <!-- Display Current User Name -->
  <div class="current-user">
    <p>You: <span th:text="${user.firstName}"></span></p>
    <input type="hidden" id="currentUserId" th:value="${user.id}">
  </div>

  <div class="chat-body">
    <h4>Your Friends:</h4>
    <ul class="user-list">
      <li th:each="friend : ${users}" th:attr="onclick=|openChat('${friend.id}', '${friend.firstName}')|">
        <p th:text="${friend.firstName}"></p>
      </li>
    </ul>
  </div>
</div>

<!-- Chat Window -->
<div id="chat-window" class="chat-window">
  <div class="chat-header">
    <span id="chat-username">Chat with Friend</span>
    <button id="close-chat-window">✕</button>
  </div>
  <div class="chat-body" id="chat-body">
    <div id="messages"></div>
  </div>
  <div class="chat-footer">
    <input id="message-input-window" type="text" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
    <button onclick="sendMessageWindow()">Send</button>
  </div>
</div>

<script>
  let currentUserId = document.getElementById("currentUserId").value;
  let currentChatUserId = null;
  let stompClient = null;

  document.addEventListener("DOMContentLoaded", function () {
      const chatButton = document.getElementById("chat-button");
      const chatPopup = document.getElementById("chat-popup");
      const closeChat = document.getElementById("close-chat");
      const closeChatWindow = document.getElementById("close-chat-window");

      chatButton.addEventListener("click", function () {
          chatPopup.style.display = "flex";
          chatButton.style.display = "none";
      });

      closeChat.addEventListener("click", function () {
          chatPopup.style.display = "none";
          chatButton.style.display = "block";
          document.getElementById("chat-window").style.display = "none";
          resetChat();
      });

      closeChatWindow.addEventListener("click", function () {
          document.getElementById("chat-window").style.display = "none";
      });

      connectWebSocket();
  });

  function connectWebSocket() {
      const socket = new SockJS("/ws");
      stompClient = Stomp.over(socket);

      stompClient.connect({}, function (frame) {
          console.log("Connected to WebSocket");
          stompClient.subscribe(`/user/${currentUserId}/queue/messages`, function (message) {
              const messageData = JSON.parse(message.body);
              displayMessage(
                      messageData.sender.id === currentUserId ? "sent" : "received",
                      messageData.messageText,
                      messageData.createdAt
                  );
          });
      }, function (error) {
          console.error("WebSocket Connection Error:", error);
      });
  }

  function openChat(userId, userName) {
      currentChatUserId = userId;
      document.getElementById("chat-username").textContent = "Chat with " + userName;
      document.getElementById("chat-window").style.display = "flex";
      document.getElementById("messages").innerHTML = "";

      fetch(`/messages/${currentUserId}/${userId}`)
          .then(response => response.json())
          .then(messages => {
              console.log(messages)
              console.log(currentUserId)
              messages.forEach(msg => {

                  displayMessage(msg.senderId == currentUserId ? "sent" : "received", msg.messageText, msg.createdAt);
              });
          })
          .catch(error => console.error("❌ Fetch error:", error));

      if (!stompClient || !stompClient.connected) {
          connectWebSocket();
      }
  }

  function sendMessageWindow() {
      const messageInput = document.getElementById("message-input-window");
      const messageText = messageInput.value.trim();

      if (messageText && stompClient) {
          const message = {
              senderId: currentUserId,
              receiverId: currentChatUserId,
              messageText: messageText,
              createdAt: new Date().toISOString() // Add current timestamp
          };

          stompClient.send("/app/sendMessage", {}, JSON.stringify(message));

          displayMessage("sent", messageText, message.createdAt); // Pass timestamp
          messageInput.value = "";
      }
  }


  function displayMessage(type, text, createdAt) {
      console.log(type)
      const messagesDiv = document.getElementById("messages");
      const messageElement = document.createElement("div");
      messageElement.className = "message " + type;

      // Format the timestamp
      const timestamp = new Date(createdAt);
      const formattedTime = timestamp.getHours().toString().padStart(2, '0') + ':' + timestamp.getMinutes().toString().padStart(2, '0');

      // Set the message text with the timestamp
      messageElement.innerHTML = `<span class="message-text">${text}</span><span class="message-time">${formattedTime}</span>`;
      messagesDiv.appendChild(messageElement);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }


  function handleKeyPress(event) {
      if (event.key === "Enter") {
          sendMessageWindow();
      }
  }

  function resetChat() {
      document.getElementById("messages").innerHTML = "";
      document.getElementById("message-input-window").value = "";
  }
</script>

</body>
</html>